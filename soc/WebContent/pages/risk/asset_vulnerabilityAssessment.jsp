<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 1.01 Transitional//EN">
<%@ taglib prefix="s" uri="/struts-tags"%>
<%@ page contentType="text/html; charset=utf-8"%>
<%@ include file="/pages/commons/meta.jsp"%>
<%@ include file="/pages/commons/taglibs.jsp"%>
<%@page import="com.soc.model.user.User"%>
<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>

<%

String path = request.getContextPath();

	String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>
<html>
<head>
<%-- <script type="text/javascript" src="${ctx}/pushlet/ajax-pushlet-client.js"></script>--%>

<link href="${ctx}/styles/asset/assetinfo.css" rel="stylesheet"
	type="text/css">

<link href="${ctx}/styles/jquery-ui.custom.css" rel="stylesheet"
	type="text/css">

<link href="${ctx}/styles/jquery.popuplayer.css" rel="stylesheet"
	type="text/css">
<link href="${ctx}/styles/fontColor.css" rel="stylesheet"
    type="text/css"> 
<script type='text/javascript' src="${ctx}/scripts/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="${ctx }/scripts/jquery-latest.js"></script>
<script type="text/javascript"
	src="${ctx }/scripts/jquery.tablesorter.js"></script>
<script type='text/javascript'
	src="${ctx}/scripts/jquery-ui.custom.min.js"></script>
<script type='text/javascript' src="${ctx}/scripts/util.js"></script>
<script type='text/javascript' src="${ctx}/scripts/popuplayer.js"></script>

<script language="javascript">
	$(document).ready(function() {
		$("#keyword").keydown(function(event) {
			if (event.keyCode == 13) {
				query();
			}
		});

		// 高级-Dialog			
		$('#dialog-extQuery').dialog({
			autoOpen : false,
			width : 450,
			height : 200,
			buttons : {
				"查询[Enter]" : function() {
					extQuery();
					$(this).dialog("close");
				},
				"取消[Esc]" : function() {
					$(this).dialog("close");
				}
			}
		});

		$('#dialog-loadAsset').dialog({
			autoOpen : false,
			width : 380,
			height : 200,
			buttons : {
				"确定[Enter]" : function() {
					importExcel($('#typeid').val());
					$(this).dialog("close");
				},
				"取消[Esc]" : function() {
					$(this).dialog("close");
				}
			}
		});
        
        
        
        $('#listTable').tablesorter();
        
        
        	// 导入高级-Dialog			
		$('#dialog-extQuery1').dialog({
			autoOpen : false,
			width : 450,
			height : 200,
			buttons : {
				"取消[Esc]" : function() {
					$(this).dialog("close");
				}
			}
		});
        
        
	});

	//快速检索
	function query() {
		//关键字
		$('#keyword').val($.trim($('#keyword').val()));
		if($('#keyword').val().length>50){
			alert("搜索长度不能大于50");
			$('#keyword').val('');
			$('#keyword').focus();
			return false;
		}
		location.href = "${ctx}/vulnerabilityAssessment/query.action?keyword="
				+ encodeURI(encodeURI($('#keyword').val(), "utf-8"));
	}

	//全选及反选
	$("#chkAll").live("click", function(event) {
		if ($("#chkAll").hasClass('not_checked')) {
			$("#chkAll").removeClass('not_checked');
			$(".check-box").attr('checked', true);
		} else {
			$("#chkAll").addClass('not_checked');
			$(".check-box").attr('checked', false);
		}
	});

	$(document).click(function(event) {
		//shiftForCheckBoxFun(event);
		destroyOverDlg();
	});

	function overDlg(e, header, content, num) {
		$('#blk_header').html(header);
		$('#blk_content').html(content);

		createOverDiv(e, 10, 10, $('#blk').html());
	}

	function extQueryDlg() {
		$('#dialog-extQuery').dialog('open');
	}

	function extQuery() {
		$('#vulnerabilityAssessmentAssetName').val($('#vulnerabilityAssessmentAssetNameValue').val());
		$('#vulnerabilityAssessmentRiskAbility').val($('#vulnerabilityAssessmentVulnerabilityValue').val());
		$('#vulnerabilityAssessmentRiskIp').val($('#vulnerabilityAssessmentRiskIpValue').val());
		var check = true;
		var reg = /^([\u4e00-\u9fa5]+|[a-zA-Z0-9]+)$/;
		var regIp = /^(25[0-5]|2[0-4]\d|[0-1]\d{2}|[1-9]?\d)\.(25[0-5]|2[0-4]\d|[0-1]\d{2}|[1-9]?\d)\.(25[0-5]|2[0-4]\d|[0-1]\d{2}|[1-9]?\d)\.(25[0-5]|2[0-4]\d|[0-1]\d{2}|[1-9]?\d)$/;
		var regNo= /^([+-]?)\d*\.?\d+$/;
		if($('#vulnerabilityAssessmentAssetName').val()!=''){
			if($('#vulnerabilityAssessmentAssetName').val().length>50){
				alert("名称长度不能大于50");
				extQueryDlg();
				$('#vulnerabilityAssessmentAssetNameValue').val('');
				$('#vulnerabilityAssessmentAssetNameValue').focus();
				check = false;
				return;
			}else{
				if(!reg.test($('#vulnerabilityAssessmentAssetName').val())){
					alert("名称不能输入特殊字符");
						extQueryDlg();
						$('#vulnerabilityAssessmentAssetNameValue').val('');
						$('#vulnerabilityAssessmentAssetNameValue').focus();
						check = false;
						return;
				}
			}
			
		}
		
		if($('#vulnerabilityAssessmentRiskIp').val()!=''){
			if(!regIp.test($('#vulnerabilityAssessmentRiskIp').val())){
				alert("请输入正确Ip地址");
				extQueryDlg();
				$('#vulnerabilityAssessmentRiskIpValue').val('');
				$('#vulnerabilityAssessmentRiskIpValue').focus();
				check = false;
				return ;
			}
		}
		
		if($('#vulnerabilityAssessmentRiskAbility').val()!=''){
			if($('#vulnerabilityAssessmentRiskAbility').val().length>50){
				alert("脆弱性值长度不能大于50");
				extQueryDlg();
				$('#vulnerabilityAssessmentVulnerabilityValue').val('');
				$('#vulnerabilityAssessmentVulnerabilityValue').focus();
				check = false;
				return ;
			}else{
				if(!regNo.test($('#vulnerabilityAssessmentRiskAbility').val())){
						alert("脆弱性值只能为数字");
						extQueryDlg();
						$('#vulnerabilityAssessmentVulnerabilityValue').val('');
						$('#vulnerabilityAssessmentVulnerabilityValue').focus();
						check = false;
						return ;
				}
			}
		}
		
		if(check){
			$('#vulnerabilityAssessmentForm').submit();
		}
	  }

	function deleteUser() {
		var ids = "";
		$("[name=ids]:checkbox:checked").each(function() {
			if (ids != "") {
				ids += "," + $(this).val();
			} else {
				ids = $(this).val();
			}
		});
		if ($(":checkbox[checked = true]").size() < 1) {
			alert("请至少选择一个资产信息...");
			return;
		}

		if (confirm("确认执行操作吗？")) {
			location.href = "${ctx}/assetRiskValue/deleteRisk.action?ids=" + ids;
		}
	}

	//更新资产状态
	function updateStatus() {
		var ids = "";
		$("[name=ids]:checkbox:checked").each(function() {
			if (ids != "") {
				ids += "," + $(this).val();
			} else {
				ids = $(this).val();
			}
		});

		if ($(":checkbox[checked = true]").size() < 1) {
			alert("请至少选择一个资产信息...");
			return;
		}

		if ($("#status").val() == 100) {
			alert("请选择需要执行的操作...");
			return;
		}

		if (confirm("确认执行操作吗？")) {
			location.href = "${ctx}/asset/updateAssetStatus.action?ids=" + ids
					+ "&status=" + $("#status").val();
		}
	}
	function gotoInfo(assetId) {
		location.href = "${ctx}/asset/queryInfo.action?assetId=" + assetId;
	}

	function exportExcel() {
		var ids = "";
		$("[name=ids]:checkbox:checked").each(function() {
			if (ids != "") {
				ids += "," + $(this).val();

			} else {

				ids = $(this).val();

			}

		});
		if ($("#chkAll").attr("checked") == true) {
			if (confirm("你是要导出选中/全部的资产...")) {
				location.href = "${ctx}/asset/export.action?ids=" + ids;
			} else {
				location.href = "${ctx}/asset/export.action";
			}
		}
		if ($("#chkAll").attr("checked") == false) {
			if (confirm("你是要导出选中/全部的威胁信息...")) {
			location.href = "${ctx}/asset/export.action?ids=" + ids;
			}
		}
	}

	function loadAssetDlg(type) {
		
		$('#dialog-extQuery1').dialog("close");
		if(type=='xml'){
			$('#typeid').val('xml');
		}else if(type=='html'||type=='html'){
			$('#typeid').val('html');
		}
		clearFile();
		$('#dialog-loadAsset').dialog('open');

	}

	function importExcel(type) {

		var upgradeFile = $("#upTar").val();
		if (upgradeFile == "") {
			alert("文件未选择！");
			return;
		} else {
			var start = upgradeFile.lastIndexOf(".");
			if(type=='xml'){
				if (upgradeFile.substr(start) == ".xml") {
					$("#importForm").submit();
				}else {
					alert("文件不是xml格式！");
				}
			}else{
				//alert(upgradeFile.substr(start));;
				if (upgradeFile.substr(start)== ".html"||upgradeFile.substr(start) == ".htm") {
					$("#importForm").submit();
				}else {
					alert("文件不是html或htm格式！");
				}
			}
			
		}

	}

	function clearFile() {
		var oldFile = document.getElementById("upTar");
		var newFile = document.createElement("input");
		newFile.id = oldFile.id;
		newFile.type = "file";
		newFile.name = "upTar";
		oldFile.parentNode.replaceChild(newFile, oldFile);
	}
	window.onload = function(){
		//alert(${info});
		var info = "${info}" ; 
		if(info != ""){
			alert("导入的html格式不正确!");
		}
	}
</script>

</head>

<body style="margin-top:2px;">
	<s:form action="query.action" namespace="/vulnerabilityAssessment" method="post"
		theme="simple" id="vulnerabilityAssessmentForm" name="vulnerabilityAssessmentForm">
		<s:hidden id="vulnerabilityAssessmentAssetName" name="vulnerabilityAssessmentAssetName" />
		<s:hidden id="vulnerabilityAssessmentRiskAbility" name="vulnerabilityAssessmentRiskAbility" />
		<s:hidden id="vulnerabilityAssessmentRiskIp" name="vulnerabilityAssessmentRiskIp" />
		
		<table width="99%" border="0" cellspacing="0" cellpadding="0"
			style="margin-left: 4px; margin-top: 0px">
			<!-- 空行 -->
			<tr>
				<td></td>
			</tr>
			<tr>
				<td>
					<div class="box">

						<div class="right">
							<!-- <input
								type="button" value="删除"
								style="margin-right:5px;margin-top:-2px" class="btnstyle"
								onclick="deleteUser();" /> -->
							<!-- <input type="button" value="导入" class="btnstyle"
								style="margin-right:5px;margin-top:-2px"
								onclick="loadAssetDlg()" /> -->
							<input type="button" value="导入" class="btnstyle"
								style="margin-right:5px;margin-top:-2px"
								onclick="$('#dialog-extQuery1').dialog('open');"  />	
						</div>

						<span class="kuaiju">快速搜索</span> <input type="text" id="keyword"
							value="${keyword}" name="keyword" class="jianju" /> <img
							src="${ctx}/images/search.jpg" onclick="query();"
							style="margin-left:5px"> <a href="#" class="jianju"
							onclick="extQueryDlg();">高级</a>
							<%-- <a href="${ctx}/vulnerabilityAssessment/export.action" class="jianju" style="color:#F00">模板下载</a>--%>
					</div>
				</td>

			</tr>
			<tr>
				<td>
					<div class="sbox">
						<div class="cont">
							<!-- information area -->
							<div id="dataList">
								<table width="100%" border="0" cellspacing="1" cellpadding="0"
									class="tab2" id="listTable">
									<thead>
									<tr height="28" class="biaoti">
										<!-- <td width="6%" class="biaoti"><input type="checkbox"
											id="chkAll" name="chkAll" class="check-box not_checked" />
										</td> -->
										<th width="7%" class="biaoti">资产编号</th>
										<th width="10%" class="biaoti">资产名称</th>
										<th width="8%" class="biaoti">IP地址</th>
										<th width="8%" class="biaoti">紧急风险</th>
										<th width="8%" class="biaoti">高级风险</th>
										<th width="8%" class="biaoti">中级风险</th>
										<th width="8%" class="biaoti">低级风险</th>
										<th width="6%" class="biaoti">信息风险</th>
										<th width="8%" class="biaoti">脆弱性风险值</th>
										<%--<th width="9%" class="biaoti">脆弱性风险级别</th>
										--%><th width="6%" class="biaoti">脆弱性值</th>
									</tr>
									</thead>
									<tbody>
									<s:iterator value="vulnerabilityAssessmentList" status="stat">
										<input type="hidden" name="vulnerabilityAssessmentId" id="vulnerabilityAssessmentId"
											value="${vulnerabilityAssessmentId}" />
										<tr>
											<%-- <td class="biaocm" valign="middle"><input
												type="checkbox" name="ids" id="${vulnerabilityAssessmentId}"
												value="${vulnerabilityAssessmentId}" class="check-box" />
											</td> --%>

											<td valign="middle">${vulnerabilityAssessmentAssetNo}
											</td>

											<td valign="middle">${vulnerabilityAssessmentAssetName}</td>

											<td valign="middle" align="center">${vulnerabilityAssessmentIp}</td>

											<td valign="middle" align="center">${vulnerabilityAssessmentEmergencyRisk}</td>


											<td valign="middle" align="center">${vulnerabilityAssessmentSeniorRisk}</td>
											
											<td valign="middle" align="center">${vulnerabilityAssessmentIntermediateRisk}</td>
											
											<td valign="middle" align="center">${vulnerabilityAssessmentLlowerRisk}</td>
											
											<td valign="middle" align="center">${vulnerabilityAssessmentIinformationRisk}</td>
											
											<td valign="middle" align="center">${vulnerabilityAssessmentRiskValue}</td>
											
											<%--<td valign="middle" align="center">${vulnerabilityAssessmentRiskLevels}</td>
											
											--%><td valign="middle" align="center">${vulnerabilityAssessmentVulnerabilityValue}</td>
										</tr>
									</s:iterator>
									</tbody>
									<tr>
										<td colspan="10" width="100%"><jsp:include
												page="../commons/page.jsp"></jsp:include></td>
									</tr>
								</table>
							</div>
							<!-- information area -->
						</div>
					</div></td>
			</tr>
		</table>
	</s:form>

	<!-- ext query from -->
	<s:form action="queryAsset.action" namespace="/asset" method="post"
		theme="simple" id="queryForm" name="queryForm">
		<s:hidden name="selAssetName" id="selAssetName" />
		<s:hidden name="selAssetIps" id="selAssetIps" />
		<s:hidden name="SelAssetImportance" id="SelAssetImportance" />
	</s:form>

	<!-- 导入form -->

	<!-- 选择文件对话框 -->
	<div id="dialog-loadAsset" title="导入风险管理对话框">
		<s:form action="importVA" namespace="/vulnerabilityAssessment" method="post"
			theme="simple" id="importForm" name="importForm"
			enctype="multipart/form-data">
			<s:hidden id="typeid" name="typeid"/>
			<table width="90%" border="0" cellspacing="5" cellpadding="5"
				align="center">
				<tr>
					<td class="td_detail_separator"></td>
				</tr>
				<tr>
					<td valign="30%" width="80px">请选择文件:</td>
					<td valign="middle"><input type="file" id="upTar" name="upTar"
						style="width:170px;" />&nbsp;</td>
				</tr>
			</table>
		</s:form>
	</div>


	<!-- over layer -->
	<div id="blk" style="display:none;">
		<div class="blk">
			<div class="head">
				<div class="head-right"></div>
			</div>
			<div class="main">
				<h2 id="blk_header">#header#</h2>
				<div id="blk_content">#content#</div>
			</div>
			<div class="foot">
				<div class="foot-right"></div>
			</div>
		</div>
	</div>

	<!-- ui-dialog -->
	<div id="dialog-extQuery" title="高级查询">
		<table width="90%" border="0" cellspacing="5" cellpadding="5"
			style="margin-left:20px;">
			<tr>
				<td width="25%">资产名称:</td>
				<td><input id="vulnerabilityAssessmentAssetNameValue" name="vulnerabilityAssessmentAssetNameValue" type="text"
					style="width:250px;" onkeypress="if(event.keyCode==13)extQuery();" />
				</td>
			</tr>
			<tr>
				<td>脆弱性值:</td>
				<td><input id="vulnerabilityAssessmentVulnerabilityValue" name="vulnerabilityAssessmentVulnerabilityValue" type="text" onkeyup="this.value=this.value.replace(/[^\d]/g,'') " onafterpaste="this.value=this.value.replace(/[^\d]/g,'') " 
					style="width:250px;" onkeypress="if(event.keyCode==13)extQuery();" />
				</td>
			</tr>
			<tr>
				<td> IP地址 :</td>
				<td><input id="vulnerabilityAssessmentRiskIpValue" name="vulnerabilityAssessmentRiskIpValue" type="text"
					style="width:250px;" onkeypress="if(event.keyCode==13)extQuery();" />
				</td>
			</tr>
		</table>
	</div>
<input type="hidden" id="actionStr" value="${actionStr }" /> 



	<!-- 导入的dialog -->
	<div id="dialog-extQuery1" title="选择导入格式">
		<table width="99%" border="0" cellspacing="0" cellpadding="0"
			style="margin-left: 4px; margin-top: 0px">
			<tr>
				<!-- left area -->
				<td width="100%" valign="top">
					<!--  左侧table-->
					<div class="framDiv" style="border:none;">
									<!-- 报表模板内容 -->
									<table width="70%" border="0" cellspacing="0" cellpadding="0"
											style="margin-left: 4px;" align="center">
											<!-- 空行 -->
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
								
											<tr>
												<%--<td align="center" width="20%">
												<img src="/soc/images/u19.png" >
													<input type="button" class="btnyh"
													id="btnSave" value="导入xml格式" onclick="loadAssetDlg('xml');" />
												</td>

												--%><td align="center" width="20%">
												<img src="/soc/images/u19.png">
													<input type="button" class="btnyh"
													id="btnSave" value="导入html格式" onclick="loadAssetDlg('html');" />
												</td>
											</tr>
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
											<tr>
												<td class="td_detail_separator"></td>
											</tr>
										</table>
						</div>
				</td>
			</tr>
			
		</table>
	</div>
</body>
</html>