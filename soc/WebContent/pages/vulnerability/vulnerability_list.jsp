<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 1.01 Transitional//EN">
<%@ taglib prefix="s" uri="/struts-tags"%>
<%@ page contentType="text/html; charset=utf-8"%>
<%@ include file="/pages/commons/meta.jsp"%>
<%@ include file="/pages/commons/taglibs.jsp"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@page import="com.soc.model.user.User"%>
<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>

<%
	String path = request.getContextPath();
	String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>
<html>

<head>
<%-- <script type="text/javascript" src="${ctx}/pushlet/ajax-pushlet-client.js"></script>--%>

<link href="${ctx}/styles/library.css" rel="stylesheet"
	type="text/css">
 <link href="${ctx}/styles/jquery-ui.custom.css" rel="stylesheet"
	type="text/css"> 
	<%-- <link href="${ctx}/styles/jquery-ui-1.8.21.css" rel="stylesheet" type="text/css"> --%>
<link href="${ctx}/styles/jquery.popuplayer.css" rel="stylesheet"
	type="text/css">
<link href="${ctx}/stylesalidationEngine.jquery.css" rel="stylesheet"
	type="text/css">
<link href="${ctx}/styles/fontColor.css" rel="stylesheet"
    type="text/css">
<script type='text/javascript' src="${ctx}/scripts/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="${ctx }/scripts/jquery-latest.js"></script>
<script type="text/javascript"
	src="${ctx }/scripts/jquery.tablesorter.js"></script>
<script type='text/javascript'
	src="${ctx}/scripts/jquery.validationEngine-en.js"></script>
<script type='text/javascript'
	src="${ctx}/scripts/jquery.validationEngine.js"></script>
<script type='text/javascript'
	src="${ctx}/scripts/jquery-ui.custom.min.js"></script>
<script type='text/javascript' src="${ctx}/scripts/util.js"></script>
<script type='text/javascript' src="${ctx}/scripts/popuplayer.js"></script>
<style type="text/css">
.btn1{ background:url(../images/btn_back_x1.png) no-repeat; width:39px; height:30px; border:none; cursor:pointer;}
</style>
<script language="javascript">
	function exportExcel() {
		var ids = "";
		$("[name=ids]:checkbox:checked").each(function() {
			if (ids != "") {
				ids += "," + $(this).val();

			} else {

				ids = $(this).val();

			}

		});	
		if (ids!="") {
			if (confirm("你是要导出选中的漏洞吗？..")){
			location.href = "${ctx}/vulnerability/checkExport.action?ids="
					+ ids;
			}
		}else{
			if (confirm("你是要导出选中的漏洞吗？..")){
				location.href = "${ctx}/vulnerability/checkExport.action?keyword="
					+ encodeURI(encodeURI($("#keyword").val(),"UTF-8"))+"&selVulnerabilityUniqueIdentification="
					+encodeURI(encodeURI($('#selVulnerabilityUniqueIdentification').val(),"UTF-8"))+"&selVulnerabilityName="+encodeURI(encodeURI($('#selVulnerabilityName').val(),"UTF-8"))
					+"&selVulnerabilityType="+encodeURI(encodeURI($('#selVulnerabilityType').val(),"UTF-8"))+"&selVulnerabilityRiskFactor="+encodeURI(encodeURI($('#selVulnerabilityRiskFactor').val(),"UTF-8"))
					+"&selVulnerabilitySynopsis="+encodeURI(encodeURI($('#selVulnerabilitySynopsis').val(),"UTF-8"));
					;
			}
		}
	}
	var rege =/^([^`~!@#$%^&*()=|{}':;, \\\[\].<>\/?~！@#￥……&*（）—|{}【】‘；：”“'。\"，、？])*$/;
	function query() {
		/* var time = $("#time").val();//最近修改用户
		var empStatus = $("#empStatus").val();//锁定
		var groupId = $("#groupId").val();//组管理
		var keyword = $("#keyword").val();//模糊
		var order = $("#order").val();//最近更新
		location.href = "${ctx}/vulnerability/query.action?keyword="
				+ encodeURIComponent(encodeURIComponent(keyword)) + "&time="
				+ time + "&empStatus=" + empStatus + "&groupId=" + groupId
				+ "&order=" + order; */

		$('#keyword').val($.trim($('#keyword').val()));
		if(parseInt($('#keyword').val().length)>50){
			alert("长度不能大于50");
			$('#keyword').val('');
			$('#keyword').focus();
			return;
		}
	
		location.href = "${ctx}/vulnerability/query.action?keyword="
				+ encodeURI(encodeURI($('#keyword').val(), "utf-8"));
	}
	$(document).ready(function() {
		$("#keyword").keydown(function(event) {
			if (event.keyCode == 13) {
				query();
			}
		});

		// Dialog			
		$('#dialog-extQuery').dialog({
			autoOpen : false,
			width : 450,
			height : 320,
			buttons : {
				"查询[Enter]" : function() {
					extQuery();
					$(this).dialog("close");
				},

				"取消[Esc]" : function() {
					$(this).dialog("close");
				}
			}
		});

		// Dialog			
		$('#dialog-loadBalancing').dialog({
			autoOpen : false,
			width : 380,
			height : 200,
			buttons : {
				"确定[Enter]" : function() {
					import1();
				},

				"取消[Esc]" : function() {
					$(this).dialog("close");
				}
			}
		});
		
	    $('#listTable').tablesorter();
		
	});

	$("#chkAll").live("click", function(event) {
		if ($("#chkAll").hasClass('not_checked')) {
			$("#chkAll").removeClass('not_checked');
			$(".check-box").attr('checked', true);
		} else {
			$("#chkAll").addClass('not_checked');
			$(".check-box").attr('checked', false);
		}
	});

	$(document).click(function(event) {
		//shiftForCheckBoxFun(event);
		destroyOverDlg();
	});

	function overDlg(e, header, content, num) {
		$('#blk_header').html(header);
		$('#blk_content').html(content);

		createOverDiv(e, 10, 10, $('#blk').html());
	}

	function extQueryDlg() {
		$('#dialog-extQuery').dialog('open');
	}

	function extQuery() {
		$('#selVulnerabilityUniqueIdentification').val(
				$.trim($('#vulnerabilityUniqueIdentification').val()));
		$('#selVulnerabilityName').val($.trim($('#vulnerabilityName').val()));
		$('#selVulnerabilityType').val($.trim($('#vulnerabilityType').val()));
		$('#selVulnerabilityRiskFactor').val(
				$.trim($('#vulnerabilityRiskFactor').val()));
		$('#selVulnerabilitySynopsis').val(
				$.trim($('#vulnerabilitySynopsis').val()));
		$('#empForm').submit();
	}

	function loadBalancingDlg() {
		$('#dialog-loadBalancing').dialog('open');
	}

	function deleteVulnerability() {
		var ids = "";
		$("[name=ids]:checkbox:checked").each(function() {
			if (ids != "") {
				ids += "," + $(this).val();
			} else {
				ids = $(this).val();
			}
		});
		if ($(":checkbox[checked = true]").size() < 1) {
			alert("请至少选择一个漏洞信息...");
			return;
		}
		if (confirm("确认执行操作吗？")) {
			location.href = "location.href='${ctx}/vulnerability/deleteVulnerability.action?ids="
					+ ids;
		}
	}

	function import1() {

		var upgradeFile = $("#upTar").val();

		if (upgradeFile == "") {
			alert("文件未选择！");
			return;
		} else {
			var start = upgradeFile.lastIndexOf(".");
			if (upgradeFile.substr(start) != ".xls")
				alert("文件不是xls格式！");
			else {
				$("#upgradeFile").val(upgradeFile);

				//$("#empForm").attr("action","${ctx}/vulnerability/importVulnerability.action?");

				$("#importForm").submit();
			}
		}

	}
	
	window.onload=function(){
		
		var str = "${field}" ; 
		if(str != ""){
			alert("导入的xls格式不正确，请点击模版下载");
		}
	}
</script>
</head>

<body style="margin-top:2px;">
	<s:form action="query.action" namespace="/vulnerability" method="post"
		theme="simple" id="empForm" name="empForm"
		enctype="multipart/form-data">
		<table width="99%" border="0" cellspacing="0" cellpadding="0"
			class="left" style="margin-left: 4px; margin-top: 0px">
			<!-- 空行 -->
			<tr>
				<td><s:hidden name="time" id="time" /> <s:hidden
						name="userStatus" id="userStatus" /> <s:hidden name="order"
						id="order" /> <s:hidden name="upgradeFile" id="upgradeFile" /> <s:hidden
						name="selVulnerabilityUniqueIdentification"
						id="selVulnerabilityUniqueIdentification" /> <s:hidden
						name="selVulnerabilityName" id="selVulnerabilityName" /> <s:hidden
						name="selVulnerabilityType" id="selVulnerabilityType" /> <s:hidden
						name="selVulnerabilityRiskFactor" id="selVulnerabilityRiskFactor" />
					<s:hidden name="selVulnerabilitySynopsis"
						id="selVulnerabilitySynopsis" /></td>
			</tr>

			<tr>
				<td>
					<div class="box">

						<div class="right">

							<input type="button" value="导入" class="btnstyle"
								style="margin-right:5px;margin-top:-2px"
								onclick="loadBalancingDlg()" /> <input type="button" value="导出"
								style="margin-right:5px;margin-top:-2px" class="btnstyle"
								onclick="exportExcel()" /> <input type="button" value="删除"
								style="margin-right:12px;margin-top:-2px" class="btnstyle"
								onclick="deleteVulnerability();" />

						</div>

						<span class="kuaiju">快速搜索</span> <input type="text" id="keyword"
							value="${keyword}" style="height: 13px;" name="keyword" class="jianju" /> <img
							src="${ctx}/images/search.jpg" onclick="query();"
							style="margin-left:5px"> <a href="#" class="jianju"
							onclick="extQueryDlg();">高级</a>
							
							<a href="${ctx}/riskfile/vulnerabilitydatabaseimport.xls" class="jianju" style="color:#F00">模板下载</a>
							
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div class="sbox">
						<div class="cont">
							<!-- information area -->
							<s:form action="query.action" namespace="/vulnerability"
								method="post" theme="simple">
								<div id="dataList">
									<table width="100%" border="0" cellspacing="1" cellpadding="0"
										class="tab2" id="listTable">
										<thead>
										<tr height="28" class="biaoti">
											<td width="6%" class="biaoti"><input type="checkbox"
												id="chkAll" name="chkAll" class="check-box not_checked" />
											</td>
											<th width="15%" class="biaoti">漏洞编号</th>
											<th width="15%" class="biaoti">名称</th>
											<th width="15%" class="biaoti">类别</th>
											<th width="10%" class="biaoti">风险等级</th>
											<th width="15%" class="biaoti">摘要</th>
										</tr>
										</thead>
										<tbody>
										<c:set value="1" var="root" />
										<c:set value="" var="resStr" />
										<s:property value="#session.XXX" />
										<s:iterator value="vulnerabilityList" status="stat">
											<input type="hidden" name="vulnerabilityId"
												id="vulnerabilityId" value="${vulnerabilityId}" />
											<tr>
												<td class="biaocm" valign="middle"><input
													type="checkbox" name="ids" id="${vulnerabilityId}"
													value="${vulnerabilityId}" class="check-box" />
												</td>
												<td valign="middle"><a
													href="${ctx}/vulnerability/editVulnerability.action?vulnerabilityId=${vulnerabilityId}&order=${order}">${vulnerabilityUniqueIdentification}</a>
												</td>
												<td valign="middle"><c:out value="${vulnerabilityName}"></c:out></td>
												<td valign="middle"><c:out value="${vulnerabilityType}"></c:out></td>
												<td valign="middle"><c:out value="${vulnerabilityRiskFactor}"></c:out></td>
												<td valign="middle"><c:out value="${vulnerabilitySynopsis}"></c:out></td>

											</tr>
											<c:set value="${root+1}" var="root" />
										</s:iterator>
										</tbody>
										<tr>
											<td colspan="6"><jsp:include page="../commons/page.jsp"></jsp:include></td>
										</tr>
									</table>
								</div>
								<!-- information area -->
							</s:form>
						</div>
					</div></td>
			</tr>
		</table>
		<!-- ui-dialog -->
		<div id="dialog-loadBalancing" title="导入对话框">
			<s:form action="importVulnerability" namespace="/vulnerability"
				method="post" theme="simple" id="importForm" name="importForm"
				enctype="multipart/form-data">
				<!--    /vulnerability/importVulnerability      -->
				<table width="90%" border="0" cellspacing="5" cellpadding="5"
					align="center">
					<tr>
						<td class="td_detail_separator"></td>
					</tr>
					<tr>
						<td width="80px">请选择文件:</td>
						<td><input type="file" id="upTar" name="upTar"
							style="width:170px;" />&nbsp;</td>
					</tr>
					<tr>
						<td></td>
						<td><span id="span_ip"></span></td>
					</tr>
				</table>
			</s:form>
		</div>


		<div id="dialog-extQuery" title="高级查询">
			<table width="90%" border="0" cellspacing="5" cellpadding="5"
				class="gaojiquery">
				<tr>
					<td width="25%">漏洞编号:</td>
					<td><input id="vulnerabilityUniqueIdentification"
						name="vulnerabilityUniqueIdentification" type="text"
						class="gaojitd" onkeypress="if(event.keyCode==13)extQuery();" />
					</td>
				</tr>
				<tr>
					<td>名称:</td>
					<td><input id="vulnerabilityName" name="vulnerabilityName"
						type="text" class="gaojitd"
						onkeypress="if(event.keyCode==13)extQuery();" />
					</td>
				</tr>
				<tr>
					<td>类别:</td>
					<td><input id="vulnerabilityType" name="vulnerabilityType"
						type="text" class="gaojitd"
						onkeypress="if(event.keyCode==13)extQuery();" />
					</td>
				</tr>
				<tr>
					<td>风险等级:</td>
					<td><input id="vulnerabilityRiskFactor"
						name="vulnerabilityRiskFactor" type="text" class="gaojitd"
						onkeypress="if(event.keyCode==13)extQuery();" />
					</td>
				</tr>
				<tr>
					<td>摘要:</td>
					<td><input id="vulnerabilitySynopsis"
						name="vulnerabilitySynopsis" type="text" class="gaojitd"
						onkeypress="if(event.keyCode==13)extQuery();" />
					</td>
				</tr>
			</table>
		</div>

	</s:form>
	<!-- over layer -->
	<div id="blk" style="display:none;">
		<div class="blk">
			<div class="head">
				<div class="head-right"></div>
			</div>
			<div class="main">
				<h2 id="blk_header">#header#</h2>
				<div id="blk_content">#content#</div>
			</div>
			<div class="foot">
				<div class="foot-right"></div>
			</div>
		</div>
	</div>

	<!-- ui-dialog -->

	<%--  <s:iterator value="#request.listVulnerability">
	${vulnerabilityType}
	</s:iterator> --%>
</body>
</html>
